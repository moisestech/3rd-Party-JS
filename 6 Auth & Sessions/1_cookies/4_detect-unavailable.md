# Detect Unavailable

**6.1.4 Detecting when cookies are unavailable**

We’ve described a number of circumstances where third-party cookies are blocked by
the browser. But this doomsday scenario doesn’t happen all of the time. Many browser
users out there have third-party cookies enabled, usually by default. You need to be
able to accurately detect when a user can and can’t set cookies so that you can take the
appropriate measures. If they can set cookies, use the tried-and-true session pattern
outlined in section 6.1.1. If they can’t set cookies, then you’ll have to use one of the
fallback techniques we’ll present shortly.
In order to test whether the browser can properly set cookies, you’ll need an
iframe element that’s pointed to a URL on your domain. This can be an existing
iframe—like the one you used as a communications channel in the last chapter—but
for example purposes, we’ll create a new iframe whose sole purpose is to tell you
whether third-party cookies are enabled.
Let’s suppose you’re using the easyXDM library to communicate with this iframe.
In your consumer JavaScript code (executing on the publisher’s website), you’d

create a new easyXDM RPC interface that expects a single remote method, testCan-
WriteCookies.

2

Here’s the code that makes it happen:
var rpc = new easyXDM.Rpc(
{
remote: "http://camerastork.com/cookies.html"
},
{
remote: {
testCanWriteCookies: {}
}
}
);

And inside cookies.html, which is the URL loaded by the iframe, you’ll need to define
a corresponding RPC object that exposes testCanWriteCookies, a global function
(within the iframe) that we’ll implement in a moment:
var rpc = new easyXDM.Rpc({},
{
local: {
testCanWriteCookies: testCanWriteCookies
}
}
);
Last, you need to implement the testCanWriteCookies function as shown in

listing 6.1. It works by attempting to create a new cookie on your domain (cameras-
tork.com) using document.cookie. Then it tries to read back all the cookies that are

on the domain and looks for the cookie that was just set. If the cookie is present—huz-
zah, the browser has third-party cookies enabled. If the cookie isn’t there, the browser

doesn’t have third-party cookies enabled.

**Listing 6.1 JavaScript to test whether cookies are enabled**

function testCanWriteCookies() {
document.cookie = 'test=1';
var allCookies = document.cookie.replace(' ', '');
allCookies = allCookies.split(';');
for (var i = 0; i < allCookies.length; i++) {
if (allCookies[i].indexOf('test=1') !== -1) {
return true;
}
}
return false;
}
Figure 6.4 illustrates this implementation.
Alternatively, you could have the HTTP response that serves the iframe set this
same test cookie (using the Cookie-set header). Afterward, you’d strictly have to
check for the presence of this test cookie in your JavaScript code. But having to muck

with HTTP headers is added complexity to what’s already a simple operation. We advo-
cate sticking with the pure JavaScript solution.

HTML5 LOCALSTORAGE AND THIRD-PARTY COOKIES HTML5 introduces a set of
JavaScript APIs for persisting data on the user’s browser. The best-known of
these, localStorage, stores data according to the current origin. It’s not
unreasonable to think, then, that you can use localStorage as an alternative
to cookies for storing the user’s session identifier when third-party cookies are
disabled in the user’s browser.
At one point, this would’ve been successful. But browser vendors have
since identified this workaround as a privacy vulnerability, and now disable
localStorage when third-party cookies are disabled. Nice try, though!

**Figure 6.4 You can use an external document to detect whether the current browser has disabled third-party cookies.**

At this point, you should have all the tools you need to detect whether third-party

cookies are disabled. But what if they are? Next up, we’ll look at a handful of work-
arounds for persisting sessions even when third-party cookies are unavailable.

---

#### From [[_1_cookies]]

[//begin]: # "Autogenerated link references for markdown compatibility"
[_1_cookies]: _1_cookies "Cookies"
[//end]: # "Autogenerated link references"
