# Receive Window Messages

## **5.1.2 Receiving messages sent to a window**

As you might’ve noticed, when the postMessage function sends a message, it doesn’t request any confirmation from the recipient window. It publishes the message to the window, and the code inside the window must subscribe to a special event if it’s inter- ested in the incoming correspondence.

Subscribing to new messages is straightforward: you attach a listener function to the window’s message event. Your listener will be called every time a new message is posted to the window from anywhere using the postMessage function. Because this is an ordinary browser event (like a mouse click event), your listener function will have access to an Event instance object. That object exposes three properties:

- data—The actual message (string or a JavaScript object)
- origin—The host from which the message was sent
- source—A reference to a Window object from which the message was sent
- Here’s an example of registering such a listener function, which we’ve named
  receiver.

**Listing 5.1 JavaScript code listening to the message window event**

```javascript
function receiver(ev) {
  console.log("We've got a message!");
  console.log("_ Message:", ev.data);
  console.log("_ Origin:", ev.origin);
  console.log("* Source:", ev.source);
}
if (window.addEventListener) {
  window.addEventListener("message", receiver, false);
} else {
  window.attachEvent("onmessage", receiver);
}
```

If you’re familiar with JavaScript events—and we hope you are—this snippet should be trivial. Note that the listener function will receive every message that’s sent to the host window; any JavaScript code that can target this window can send it a message, including untrusted parties. The browser doesn’t verify the source of the message, so it’s up to you to check the origin property and decide whether the message is legiti- mate or not. As a rule of thumb, you should always check the origin property by com- paring it to a list of your trusted hosts to make sure that you trust the message’s sender.

It’s also a good idea to check the message itself, just to be certain that it doesn’t contain any values you don’t expect. If for some strange reason you’re thinking about blindly evaluating the message using the eval function, ask your neighbor to punch you and think again. Blindly evaluating the message using eval is like giving any script on the page—including potentially malicious ones—a JavaScript console running on your domain with permission to do whatever they want. Not a good idea. The code in listing 5.2 implements the diagram we showed you in figure 5.1. The receiver listens to all messages but recognizes only those that originate from cameras- tork.com. If the message from camerastork.com contains a string "hello", the receiver sends back a message with a string "world". Note that messages between window objects are all done on the client—they don’t perform any network requests and are blazingly fast.

**Listing 5.2 Event handler rejects messages that don’t originate from camerastork.com.**

```javascript
function receiver(ev) {
  if (ev.origin !== "http://camerastork.com/") {
    return;
  }
  if (ev.data === "hello") {
    ev.source.postMessage("world", "http://camerastork.com/");
  }
}
if (window.addEventListener) {
  window.addEventListener("message", receiver, false);
} else {
  window.attachEvent("onmessage", receiver);
}
```

As you can see from the examples, the window.postMessage API is simple and it solves just one problem—the problem of exchanging messages between windows. Everything else—from simple origin checks to the complex relationships between messages—is outside of the window.postMessage specification and must be handled by you. We’ll show you how to build a simple request/response system later in this chapter. But now let’s talk about something that most often kills all the excitement about shiny, new HTML or JavaScript features. Let’s talk about browser compatibility.

(Spoiler: it’s not that bad.)

---

#### From [[_1_windows-message-api]]

[//begin]: # "Autogenerated link references for markdown compatibility"
[_1_windows-message-api]: _1_windows-message-api "Windows Message API"
[//end]: # "Autogenerated link references"
